#
# GitLab CI: Laravel
#
#
FROM php:8.1.4-fpm-alpine3.14
LABEL MAINTAINER="Khin Chan Myae Htun <khinchanmyaehtun@gmail.com>"

RUN apk upgrade --update -q

RUN apk --no-cache -q add openssl zip libzip-dev unzip git mysql-client vim coreutils freetype-dev libpng-dev libjpeg-turbo-dev freetype libpng libjpeg-turbo libltdl libmcrypt-dev icu-dev postgresql-dev

RUN apk --no-cache -q add npm yarn supervisor

RUN docker-php-ext-configure gd \
    --with-jpeg \
    --with-freetype && \
  NPROC=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || 1)

RUN docker-php-ext-install -j$(nproc) gd pdo pdo_mysql opcache zip calendar exif pcntl

RUN docker-php-ext-configure intl && docker-php-ext-install intl

RUN docker-php-ext-install mysqli pdo pgsql pdo_pgsql

# Iconv
RUN apk add --no-cache --repository http://dl-cdn.alpinelinux.org/alpine/v3.13/community/ gnu-libiconv=1.15-r3
ENV LD_PRELOAD /usr/lib/preloadable_libiconv.so php

#Imagick
#RUN apk add --update --no-cache autoconf g++ imagemagick imagemagick-dev libtool make pcre-dev \
 #  pecl install imagick \
 #  && docker-php-ext-enable imagick
#RUN pecl install redis
RUN apt-get install -y libmagickwand-dev; \
   && pecl install imagick; \
   && docker-php-ext-enable imagick

#RUN wget "https://github.com/phpredis/phpredis/archive/5.6.tar.gz" && tar xf 5.6tar.gz && rm 5.6tar.gz && mkdir -p /usr/src/php/ext && mv phpredis-5.6 /usr/src/php/ext/redis && docker-php-ext-install redis

RUN add --update --no-ccche --virtual .phpize-deps $PHPIZE_DEPS \
    && pecl install-o -f reids \
    && docker-php-ext-enable redis \
    && rm -rf /tmp/* \
    && apk del .phpize-deps

RUN rm -rf /var/cache/apk/*
ADD ./php.ini /usr/local/etc/php
ADD ./php.conf /usr/local/etc/php-fpm.d/www.conf


ARG ENABLE_XDEBUG=false

RUN if [ $ENABLE_XDEBUG = "true" ] ; then \
    pecl install xdebug; \
    docker-php-ext-enable xdebug; \
    echo "error_reporting = E_ALL" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini; \
    echo "display_startup_errors = On" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini; \
    echo "display_errors = On" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini; \
    echo "xdebug.remote_enable=1" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini; \
fi ;

WORKDIR /app

RUN adduser -u 1000 -D -S -G root -G www-data -h /home/nexlabs nexlabs

USER nexlabs

RUN mkdir -p /home/nexlabs/.local/bin && curl -sS https://getcomposer.org/installer | php -- --install-dir=/home/nexlabs/.local/bin --filename=composer

# Add ~/.local/bin to PATH variable
ENV PATH="$PATH:/home/nexlabs/.local/bin/"

# Install PhpMetric
RUN composer global require 'phpmetrics/phpmetrics'

